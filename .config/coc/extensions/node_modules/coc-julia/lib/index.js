!function(t,e){for(var i in e)t[i]=e[i];e.__esModule&&Object.defineProperty(t,"__esModule",{value:!0})}(exports,(()=>{var t=[(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.activate=void 0;const s=i(1),n=i(2);e.activate=async function(t){const e=new n.Ctx(t);e.config.enabled&&(e.resolveJuliaBin()?(await e.startServer(),t.subscriptions.push(s.commands.registerCommand("julia.CompileLanguageServerBin",(async()=>{await e.compileServerBin()})),s.commands.registerCommand("julia.CompileLanguageServerSysimg",(async()=>{await e.compileServerSysimg()})))):s.window.showMessage("Can't find julia","warning"))}},t=>{"use strict";t.exports=require("coc.nvim")},function(t,e,i){"use strict";var s=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.Ctx=void 0;const n=i(3),r=i(1),o=s(i(4)),a=s(i(5)),c=s(i(6)),l=i(7),u=s(i(8)),p=l.promisify(n.exec);class h{constructor(){this.cfg=r.workspace.getConfiguration("julia")}get enabled(){return this.cfg.get("enabled")}get executablePath(){return this.cfg.get("executablePath")}get environmentPath(){return this.cfg.get("environmentPath")}}e.Ctx=class{constructor(t){this.context=t,this.config=new h,this.lsProj=c.default.join(t.extensionPath,"server","JuliaLS"),this.mainJulia=c.default.join(t.extensionPath,"server","JuliaLS/src/main.jl"),this.compileEnv=c.default.join(t.extensionPath,"server","compile_env"),o.default.existsSync(t.storagePath)||o.default.mkdirSync(t.storagePath),this.serverRoot=c.default.join(t.storagePath,"JuliaLS"),o.default.existsSync(this.serverRoot)||o.default.mkdirSync(this.serverRoot),this.sysimgDir=c.default.join(t.storagePath,"sysimg"),o.default.existsSync(this.sysimgDir)||o.default.mkdirSync(this.sysimgDir)}resolveJuliaBin(){let t=this.config.executablePath;if(t.startsWith("~")&&(t=a.default.homedir()+t.slice(1)),t&&o.default.existsSync(t))return t;const e="win32"===process.platform?"julia.exe":"julia";return u.default.sync(e,{nothrow:!0})}formatPkg(t){const e=[];for(const i of t){const t=i.split(" ");4!==t.length&&5!==t.length||e.push({state:t[0],hash:t[1],name:t[2],version:t[3],repo:t[4]||""})}return e}async resolveMissingPkgs(t){const e=this.resolveJuliaBin();let i=`${e} --project="${t}" --startup-file=no --history-file=no -e "using Pkg; Pkg.status()"`;if(this.formatPkg((await p(i)).stdout.split("\n")).some((t=>"â†’"===t.state))){const s=c.default.basename(t);await r.window.showPrompt(`Some ${s} deps are missing, would you like to install now?`)&&(i=`${e} --project="${t}" --startup-file=no --history-file=no -e "using Pkg; Pkg.instantiate()"`,await r.workspace.createTerminal({name:"coc-julia-ls"}).then((t=>t.sendText(i))))}}async resolveEnvPath(){if(this.config.environmentPath)return this.config.environmentPath;const t=this.resolveJuliaBin()+' --project=@. --startup-file=no --history-file=no -e "using Pkg; println(dirname(Pkg.Types.Context().env.project_file))"';return(await p(t)).stdout.trim()}async resolveSysimgPath(){let t="sysimg.so";switch(process.platform){case"win32":t="sysimg.dll";break;case"darwin":t="sysimg.dylib"}const e=c.default.join(this.sysimgDir,t);if(o.default.existsSync(e))return e;const i=`${this.resolveJuliaBin()} --project=${this.compileEnv} --startup-file=no --history-file=no -e "import PackageCompiler; println(PackageCompiler.default_sysimg_path())"`;return(await p(i)).stdout.trim()}async resolveExecFile(){const t=`${this.resolveJuliaBin()} --project=${this.lsProj} --startup-file=no --history-file=no -e "import LanguageServer; println(joinpath(dirname(pathof(LanguageServer)), \\"../test/runtests.jl\\"))"`;return(await p(t)).stdout.trim()}async compileServerSysimg(){r.window.showMessage("PackageCompiler.jl will take about 5 mins to compile...");const t=this.resolveJuliaBin(),e=await this.resolveExecFile();await r.workspace.createTerminal({name:"coc-julia-ls"}).then((i=>{const s=`${t} --project=${this.compileEnv} ${c.default.join(this.compileEnv,"compile.jl")} -s ${this.lsProj} ${this.sysimgDir} ${e}`;i.sendText(s)}))}async compileServerBin(){r.window.showMessage("PackageCompiler.jl will take about 10 mins to compile...");const t=this.resolveJuliaBin(),e=await this.resolveExecFile();await r.workspace.createTerminal({name:"coc-julia-ls"}).then((i=>{const s=`${t} --project=${this.compileEnv} ${c.default.join(this.compileEnv,"compile.jl")} -b ${this.lsProj} ${this.serverRoot} ${e}`;i.sendText(s)}))}async prepareJuliaArgs(){return["--startup-file=no","--history-file=no","--sysimage="+await this.resolveSysimgPath(),"--depwarn=no","--project="+this.lsProj,this.mainJulia]}async prepareLSArgs(){return[await this.resolveEnvPath(),"--debug=no",process.env.JULIA_DEPOT_PATH?process.env.JULIA_DEPOT_PATH:"",this.context.storagePath]}async startServer(){await this.resolveMissingPkgs(this.compileEnv);let t=c.default.join(this.serverRoot,"bin","win32"===process.platform?"JuliaLS.exe":"JuliaLS"),e=await this.prepareLSArgs();o.default.existsSync(t)||(await this.resolveMissingPkgs(this.lsProj),t=this.resolveJuliaBin(),e=(await this.prepareJuliaArgs()).concat(e));const i=await r.workspace.nvim.eval("$TMPDIR"),s=r.window.createOutputChannel("Julia Language Server Trace"),n={command:t,args:e,options:{env:Object.assign(Object.assign({},process.env),{TMPDIR:i})}},a={documentSelector:["julia","juliamarkdown"],initializationOptions:r.workspace.getConfiguration("julia"),synchronize:{configurationSection:["julia.lint","julia.format"],fileEvents:r.workspace.createFileSystemWatcher("**/*.{jl,jmd}")},progressOnInitialization:!0,outputChannel:s,middleware:{provideCompletionItem:async(t,e,i,s,n)=>{const o=i.option,a=o.input.startsWith(o.word)?o.input:o.word+o.input,c=await n(t,e,i,s),l=[];if(c&&Array.isArray(c.items))for(const t of c.items){if(t.textEdit&&r.TextEdit.is(t.textEdit)&&11!==t.kind){const e=t.textEdit.newText;if(!e.startsWith(a)){const i=Object.assign({},t.textEdit.range),s=r.Position.create(i.start.line,i.start.character-a.length),n=r.Position.create(i.end.line,i.end.character);t.textEdit.newText=`${a}${e}`,t.textEdit.range=r.Range.create(s,n)}}l.push(t)}return{items:l,isIncomplete:c.isIncomplete}}}},l=new r.LanguageClient("julia","Julia Language Server",n,a);this.context.subscriptions.push(r.services.registLanguageClient(l))}}},t=>{"use strict";t.exports=require("child_process")},t=>{"use strict";t.exports=require("fs")},t=>{"use strict";t.exports=require("os")},t=>{"use strict";t.exports=require("path")},t=>{"use strict";t.exports=require("util")},(t,e,i)=>{const s="win32"===process.platform||"cygwin"===process.env.OSTYPE||"msys"===process.env.OSTYPE,n=i(6),r=s?";":":",o=i(9),a=t=>Object.assign(new Error("not found: "+t),{code:"ENOENT"}),c=(t,e)=>{const i=e.colon||r,n=t.match(/\//)||s&&t.match(/\\/)?[""]:[...s?[process.cwd()]:[],...(e.path||process.env.PATH||"").split(i)],o=s?e.pathExt||process.env.PATHEXT||".EXE;.CMD;.BAT;.COM":"",a=s?o.split(i):[""];return s&&-1!==t.indexOf(".")&&""!==a[0]&&a.unshift(""),{pathEnv:n,pathExt:a,pathExtExe:o}},l=(t,e,i)=>{"function"==typeof e&&(i=e,e={}),e||(e={});const{pathEnv:s,pathExt:r,pathExtExe:l}=c(t,e),u=[],p=i=>new Promise(((r,o)=>{if(i===s.length)return e.all&&u.length?r(u):o(a(t));const c=s[i],l=/^".*"$/.test(c)?c.slice(1,-1):c,p=n.join(l,t),f=!l&&/^\.[\\\/]/.test(t)?t.slice(0,2)+p:p;r(h(f,i,0))})),h=(t,i,s)=>new Promise(((n,a)=>{if(s===r.length)return n(p(i+1));const c=r[s];o(t+c,{pathExt:l},((r,o)=>{if(!r&&o){if(!e.all)return n(t+c);u.push(t+c)}return n(h(t,i,s+1))}))}));return i?p(0).then((t=>i(null,t)),i):p(0)};t.exports=l,l.sync=(t,e)=>{e=e||{};const{pathEnv:i,pathExt:s,pathExtExe:r}=c(t,e),l=[];for(let a=0;a<i.length;a++){const c=i[a],u=/^".*"$/.test(c)?c.slice(1,-1):c,p=n.join(u,t),h=!u&&/^\.[\\\/]/.test(t)?t.slice(0,2)+p:p;for(let t=0;t<s.length;t++){const i=h+s[t];try{if(o.sync(i,{pathExt:r})){if(!e.all)return i;l.push(i)}}catch(t){}}}if(e.all&&l.length)return l;if(e.nothrow)return null;throw a(t)}},(t,e,i)=>{var s;function n(t,e,i){if("function"==typeof e&&(i=e,e={}),!i){if("function"!=typeof Promise)throw new TypeError("callback not provided");return new Promise((function(i,s){n(t,e||{},(function(t,e){t?s(t):i(e)}))}))}s(t,e||{},(function(t,s){t&&("EACCES"===t.code||e&&e.ignoreErrors)&&(t=null,s=!1),i(t,s)}))}i(4),s="win32"===process.platform||global.TESTING_WINDOWS?i(10):i(11),t.exports=n,n.sync=function(t,e){try{return s.sync(t,e||{})}catch(t){if(e&&e.ignoreErrors||"EACCES"===t.code)return!1;throw t}}},(t,e,i)=>{t.exports=r,r.sync=function(t,e){return n(s.statSync(t),t,e)};var s=i(4);function n(t,e,i){return!(!t.isSymbolicLink()&&!t.isFile())&&function(t,e){var i=void 0!==e.pathExt?e.pathExt:process.env.PATHEXT;if(!i)return!0;if(-1!==(i=i.split(";")).indexOf(""))return!0;for(var s=0;s<i.length;s++){var n=i[s].toLowerCase();if(n&&t.substr(-n.length).toLowerCase()===n)return!0}return!1}(e,i)}function r(t,e,i){s.stat(t,(function(s,r){i(s,!s&&n(r,t,e))}))}},(t,e,i)=>{t.exports=n,n.sync=function(t,e){return r(s.statSync(t),e)};var s=i(4);function n(t,e,i){s.stat(t,(function(t,s){i(t,!t&&r(s,e))}))}function r(t,e){return t.isFile()&&function(t,e){var i=t.mode,s=t.uid,n=t.gid,r=void 0!==e.uid?e.uid:process.getuid&&process.getuid(),o=void 0!==e.gid?e.gid:process.getgid&&process.getgid(),a=parseInt("100",8),c=parseInt("010",8);return i&parseInt("001",8)||i&c&&n===o||i&a&&s===r||i&(a|c)&&0===r}(t,e)}}],e={};return function i(s){if(e[s])return e[s].exports;var n=e[s]={exports:{}};return t[s].call(n.exports,n,n.exports,i),n.exports}(0)})());